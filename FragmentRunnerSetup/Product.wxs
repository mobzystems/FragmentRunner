<?xml version="1.0" encoding="UTF-8"?>

<!-- Change ONCE -->

<!-- Product name. Used in title and Start Menu folder -->
<?define PRODUCTNAME="Fragment Runner"?>
<!-- Manufacturer name -->
<?define MANUFACTURER="MOBZystems"?>
<!-- The folder name to install to (inside ProgramFiles\Manufacturer) -->
<?define FOLDERNAME="Fragment Runner"?>
<!-- Fixed upgrade code for this product -->
<?define UPGRADECODE="dc8018fe-f1e4-4db8-bdbf-d474243a9fbc"?>

<!-- Change ALL OF THESE, ON EVERY NEW VERSION -->
<?define VERSION="0.9.1"?>
<?define PRODUCTCODE="{60487F48-0E7B-44DC-8490-C342C52BA349}"?>

<!-- Change at will -->
<!--
  Choose an install type:
  
  - silent: practically no UI, installation starts when the MSI is started
  - minimal: just a welcome dialog. Nu EULA, no choice of installation folder
-->
<?define INSTALLTYPE="minimal"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Name="$(var.PRODUCTNAME) $(var.VERSION)"  Id="$(var.PRODUCTCODE)" UpgradeCode="$(var.UPGRADECODE)" Language="1033" Version="$(var.VERSION)" Manufacturer="$(var.MANUFACTURER)">
    <Package Description="$(var.PRODUCTNAME) $(var.VERSION)" InstallerVersion="200" Languages="1033" Compressed="yes" InstallScope="perMachine" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowSameVersionUpgrades="no"/>
    <MediaTemplate CabinetTemplate="cab{0}.cab" EmbedCab="yes"/>

    <!-- Hack to prevent all kinds of ICE warnings. All shortcuts are declared as Advertised (for per Machine installation) but are not installed as such. -->
    <Property Id="DISABLEADVTSHORTCUTS" Value="1" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      
      <!-- The physical folder structure -->
      <Directory Id="ProgramFilesFolder">
        <!-- Enable this element for a manufacturer folder in Program Files -->
        <Directory Id="ManufacturerFolder" Name="$(var.MANUFACTURER)">
          <Directory Id="INSTALLDIR" Name="$(var.FOLDERNAME)">
            <!-- TODO: Create new GUID here -->
            <Component Id="MainExecutable_Component" Guid="{84A2E297-36A6-4E90-8382-9739614F94CE}">
              <File Id="MainExeFile" Name="$(var.FragmentRunner.TargetFileName)" Source="$(var.FragmentRunner.TargetPath)"  KeyPath="yes">
                <Shortcut Id="MainShortcut" Directory="ProgramMenuAppFolder" Name="$(var.PRODUCTNAME)" Description="$(var.PRODUCTNAME) $(var.VERSION)" WorkingDirectory="INSTALLDIR" Icon="$(var.FragmentRunner.TargetFileName)" IconIndex="0" Advertise="yes" />
              </File>
            </Component>
            <!-- TODO: add new files here -->
            <Component Id="DemoApp_Component" Guid="{2BE9DAC8-1E81-4639-9F7D-928BAFCCD896}">
              <File Name="$(var.FuncPlotter.TargetFileName)" Source="$(var.FuncPlotter.TargetPath)" KeyPath="yes">
                <Shortcut Id="DemoShortcut" Directory="ProgramMenuAppFolder" Name="Func Plotter (Demo application)" WorkingDirectory="INSTALLDIR" Icon="$(var.FuncPlotter.TargetFileName)" IconIndex="0" Advertise="yes" />
              </File>
              <File Name="Mobzystems.CodeFragments.dll" Source="$(var.FuncPlotter.TargetDir)\Mobzystems.CodeFragments.dll"/>
            </Component>
          </Directory>
        </Directory>
      </Directory>

      
      <!-- Start menu folder structure -->
      
      <Directory Id="ProgramMenuFolder">
        <!--<Directory Id="ManufacturerAppFolder" Name="$(var.MANUFACTURER)">-->
          <Directory Id="ProgramMenuAppFolder" Name="$(var.PRODUCTNAME)">
            <!-- TODO: Create new GUID here -->
            <Component Id="ProgramMenuFolder_Component" Guid="{D1D2551B-787B-48F7-BA61-35BDFD976F2A}">
              <RemoveFolder Id="ProgramMenuAppFolder" On="uninstall" />
              <RegistryValue Root="HKMU" Key="Software\[Manufacturer]\$(var.PRODUCTNAME)" Type="string" Value="" KeyPath="yes" />
            </Component>
          </Directory>
          <!-- TODO: Create new GUID here -->
          <!--<Component Id="ManufacturerMenuFolder_Component" Guid="{FE3CCBF0-D709-4401-B841-FD107A2B9AB6}">
            <RemoveFolder Id="ManufacturerAppFolder" On="uninstall" />
            <RegistryValue Root="HKMU" Key="Software\[Manufacturer]" Type="string" Value="" KeyPath="yes" />
          </Component>-->
        </Directory>
      <!--</Directory>-->
    </Directory>

    <Feature Id="Complete" Level="1">
      <!-- Main component -->
      <ComponentRef Id="MainExecutable_Component" />

      <!-- Optional component(s) -->
      <ComponentRef Id="DemoApp_Component" />

      <!-- this component installs the start menu folder -->
      <!--<ComponentRef Id="ManufacturerMenuFolder_Component" />-->
      <ComponentRef Id="ProgramMenuFolder_Component" />
    </Feature>

    <!-- Icons -->
    <Icon Id="$(var.FragmentRunner.TargetFileName)" SourceFile="$(var.FragmentRunner.TargetPath)" />
    <Icon Id="$(var.FuncPlotter.TargetFileName)" SourceFile="$(var.FuncPlotter.TargetPath)" />

    <!-- UI type -->
    
    <?if $(var.INSTALLTYPE) = "silent" ?>
    
    <!-- Silent: nothing to include - no UI!-->
    
    <?elseif $(var.INSTALLTYPE) = "minimal"?>

    <!-- Minimal: skip EULA -->
    
    <UI Id="MinimalWithoutEULA_UI">
      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      <Property Id="WixUI_Mode" Value="Minimal" />

      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />

      <DialogRef Id="WelcomeDlg" />

      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="PrepareDlg">1</Publish>

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>

      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

      <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

      <Property Id="ARPNOMODIFY" Value="1" />
    </UI>

    <?endif?>

    <UIRef Id="WixUI_Common" />

  </Product>
</Wix>